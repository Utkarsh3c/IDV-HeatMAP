<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Activity Heatmap Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 8px;
      z-index: 1000;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      max-width: 300px;
      font-family: sans-serif;
      font-size: 14px;
    }
    .controls label {
      display: block;
      margin-top: 8px;
      font-weight: bold;
    }
    .controls input[type="file"] {
      width: 100%;
      margin-top: 4px;
      box-sizing: border-box;
    }
    .activity-group {
      margin-top: 8px;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .activity-group label {
      font-weight: normal;
      margin-top: 4px;
    }
    .activity-group input[type="range"] {
      width: 100%;
      margin-top: 4px;
    }
    .leaflet-control-recenter {
      background: white;
      width: 24px;
      height: 24px;
      cursor: pointer;
      border: 1px solid #888;
      box-shadow: 0 0 2px rgba(0,0,0,0.6);
      text-align: center;
      line-height: 24px;
      font-size: 16px;
    }
    .leaflet-control-recenter:hover { background: #f0f0f0; }
    .popup-table {
      border-collapse: collapse;
      width: 100%;
    }
    .popup-table th, .popup-table td {
      border: 1px solid #ddd;
      padding: 4px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <label for="data-file">Upload CSV/JSON/GPX/TCX/TCS</label>
    <input type="file" id="data-file" accept=".csv,.json,.gpx,.tcx,.tcs" multiple>
    <div id="activity-controls"></div>
  </div>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@tmcw/togeojson@0.17.0/dist/togeojson.js"></script>

  <script>
    const CENTER = [1.3521, 103.8198];
    const ZOOM = 12;
    const DEFAULT_RADIUS = 8;
    const BUFFER_RADIUS_METERS = 500;

    const map = L.map('map').setView(CENTER, ZOOM);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);
    map.on('dragend', () => map.flyTo(CENTER, ZOOM, { duration: 1.2, easeLinearity: 0.3 }));

    const RecenterControl = L.Control.extend({ options: { position: 'topleft' }, onAdd: () => {
      const btn = L.DomUtil.create('div', 'leaflet-control-recenter');
      btn.innerHTML = 'âŸ³'; btn.title = 'Re-center';
      L.DomEvent.on(btn, 'click', () => map.flyTo(CENTER, ZOOM, { duration: 1.2, easeLinearity: 0.3 }));
      return btn;
    }});
    map.addControl(new RecenterControl());

    let allData = [];
    let layers = {};
    let settings = {};

    function ingest(rows) { allData = allData.concat(rows); updateLayers(); }

    function updateLayers() {
      Object.values(layers).forEach(layer => map.removeLayer(layer));
      layers = {};
      const buckets = {};
      allData.forEach(r => {
        (buckets[r.activity_type] || (buckets[r.activity_type] = [])).push([r.lat, r.lon, r.weight || 1]);
      });
      const ctrl = document.getElementById('activity-controls'); ctrl.innerHTML = '';
      Object.entries(buckets).forEach(([type, pts]) => {
        if (!settings[type]) settings[type] = { blur: 15 };
        const layer = L.heatLayer(pts, { radius: DEFAULT_RADIUS, blur: settings[type].blur, maxZoom: ZOOM + 1 });
        layers[type] = layer; layer.addTo(map);
        const group = document.createElement('div'); group.className = 'activity-group';
        const chk = document.createElement('input'); chk.type = 'checkbox'; chk.checked = true; chk.id = `chk-${type}`;
        const lblChk = document.createElement('label'); lblChk.htmlFor = chk.id; lblChk.textContent = ` ${type}`;
        group.appendChild(chk); group.appendChild(lblChk);
        chk.addEventListener('change', e => e.target.checked ? layer.addTo(map) : map.removeLayer(layer));
        const lblBlur = document.createElement('label'); lblBlur.textContent = 'Blur:';
        const rngBlur = document.createElement('input'); rngBlur.type = 'range'; rngBlur.min = 1; rngBlur.max = 50; rngBlur.value = settings[type].blur;
        rngBlur.addEventListener('input', e => { settings[type].blur = +e.target.value; layer.setOptions({ radius: DEFAULT_RADIUS, blur: settings[type].blur }); });
        group.appendChild(lblBlur); group.appendChild(rngBlur);
        ctrl.appendChild(group);
      });
    }

    // distance in meters between two lat-lngs
    function haversine(lat1, lon1, lat2, lon2) {
      const toRad = d => d * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // click to show buffer stats popup
    map.on('click', function(e) {
      const { lat, lng } = e.latlng;
      const stats = {};
      allData.forEach(pt => {
        const d = haversine(lat, lng, pt.lat, pt.lon);
        if (d <= BUFFER_RADIUS_METERS) {
          stats[pt.activity_type] = (stats[pt.activity_type] || 0) + 1;
        }
      });
      let html = `<div><strong>Buffer ${BUFFER_RADIUS_METERS}m Stats</strong><table class='popup-table'><tr><th>Activity</th><th>Count</th></tr>`;
      Object.entries(stats).forEach(([type, count]) => { html += `<tr><td>${type}</td><td>${count}</td></tr>`; });
      html += `</table></div>`;
      L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
    });

    function parseTCX(xmlStr) {
      const xml = new DOMParser().parseFromString(xmlStr, 'application/xml');
      const type = xml.querySelector('Activity')?.getAttribute('Sport')?.toLowerCase() || 'running';
      return Array.from(xml.getElementsByTagName('Trackpoint')).map(tp => ({ activity_type: type, lat: parseFloat(tp.getElementsByTagName('LatitudeDegrees')[0]?.textContent), lon: parseFloat(tp.getElementsByTagName('LongitudeDegrees')[0]?.textContent), timestamp: tp.getElementsByTagName('Time')[0]?.textContent })).filter(pt => pt.lat && pt.lon);
    }

    document.getElementById('data-file').addEventListener('change', e => {
      Array.from(e.target.files).forEach(file => {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === 'csv') Papa.parse(file, { header: true, dynamicTyping: true, complete: res => ingest(res.data) });
        else if (ext === 'json') file.text().then(txt => ingest(JSON.parse(txt)));
        else if (ext === 'gpx') file.text().then(xml => {
          const dom = new DOMParser().parseFromString(xml, 'text/xml');
          const geo = toGeoJSON.gpx(dom);
          ingest(geo.features.flatMap(fe => fe.geometry.coordinates.map((c,i) => ({ activity_type: 'running', lon: c[0], lat: c[1], timestamp: fe.properties.coordTimes[i] }))));
        });
        else if (['tcx','tcs'].includes(ext)) file.text().then(txt => ingest(parseTCX(txt)));
      });
      e.target.value = '';
    });
  </script>
</body>
</html>
